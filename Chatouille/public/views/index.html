<!DOCTYPE html>
<html lang="fr">
    <head>
		<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/themes/blitzer/jquery-ui.css" type="text/css" />
        <link rel="stylesheet" href="css/main.css" type="text/css" />
		<script src="socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
        <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
		<script src="/js/utils.js"></script>
		<title>Chatouille - Chat en ligne</title>
        <script>
            var socket = io.connect('http://localhost');
            $(document).ready(function(){
				/* Mise en forme générale, ... */
				var active_tab = "general";
				$('.button').button();
				$('.small_button').button();
				$("#message_input").val('');
				$('#send_message').button({ disabled: true });
				$('#change_pseudo').button({ disabled: false });
				$('#pseudo_input').val('');
				$('#pseudo_input').attr("disabled", false);
				$('input[type=text]').addClass('ui-state-default ui-corner-all');
				$('input[type=text]').bind({
					focusin: function() {
						$(this).toggleClass('ui-state-focus');
					},
					focusout: function() {
						$(this).toggleClass('ui-state-focus');
					}
				});
				/* Fin mise en forme */

				socket.on('new_message', function (data) {
					var temp_index = $("div[room='"+data.tag+"']").attr('id');
					var temp_class = "";
					if(data.nickName == "MrChatouille")
						temp_class="user_chatouille";
					else
						temp_class="user_"+data.from;
					
					if(display_twittes != true && data.from == "tweeter")
						temp_class += " hidden";
					
					var date = new Date(data.time);
					date = date.toLocaleDateString() + " à " +date.toLocaleTimeString();
					var content = Get_Emoticon(data.content);
					
					//console.log(data);
					if(data.tag != active_tab && data.nickName != "MrChatouille")
					{
						$("li[room='"+data.tag+"']").removeClass("ui-state-default").addClass( "not_read");
					}
					
					$('#'+temp_index+' .container').append("<div class='"+temp_class+"'><abbr title='"+date.capitalize()+"'><span class='pseudo'>"+data.nickName+" dit : </span>"+content+"</abbr></div>");
					$('#'+temp_index+' .container').scrollTop($('#'+temp_index+' .container').height());
				});

				$('#send_message').click(function(){
					var temp_msg = Check_Command($("#message_input").val());
					if(temp_msg == "message")
						socket.emit('new_message', {tag:active_tab,content:$("#message_input").val()});
					else if(temp_msg == false)
					{
						
					}
					else
					{
						var temp_index = $("div[room='"+active_tab+"']").attr('id');
						$('#'+temp_index+' .container').append(temp_msg);
					}
					
					$("#message_input").val('');
					$("#message_input").focus();
					$('#send_message').button({ disabled: true });
				});
				
				if($("#message_input").length > 0)
				{
					$("#message_input").keypress(function (e){
						code = e.keyCode ? e.keyCode : e.which;
						  if(code.toString() == 13) 
						  {
							 $("#send_message").click();
						  }
					})
				}
				
				if($("#pseudo_input").length > 0)
				{
					$("#pseudo_input").keypress(function (e){
						code = e.keyCode ? e.keyCode : e.which;
						  if(code.toString() == 13) 
						  {
							$("#change_pseudo").click();
						  }
					})
				}
					
				if($( "#join_chan" ).length > 0)
				{
					$("#join_chan").keypress(function (e){
						code = e.keyCode ? e.keyCode : e.which;
						  if(code.toString() == 13) 
						  {
							$("#join_chan_button").click();
						  }
					})
				}
				
				$("#message_input").keyup(function (){
					if($(this).val().length >= 1)
					{
						$('#send_message').button({ disabled: false });
					}
					else
						$('#send_message').button({ disabled: true });
				});
				
				socket.on('connected_users', function(data) {
					$("div[room='"+data.tag+"'] .user_list").html("");
					$("div[room='"+data.tag+"'] .user_list").append("<ul>");
					$.each(data.users, function(i,j){
						var temp_content = "";
						if(j.role=="bot")
							temp_content = "<li class='nickname_bot' nick='"+j.nickname+"'><img src='/img/ressources/bot.png'/> "+j.nickname+"</li>";
						else if(j.role=="admin")
							temp_content = "<li class='nickname_admin' nick='"+j.nickname+"'><img src='/img/ressources/etoile.png'/> "+j.nickname+"</li>";
						else
							temp_content = "<li class='nickname_user' nick='"+j.nickname+"'>"+j.nickname+"</li>";
							
						$("div[room='"+data.tag+"'] .user_list").append(temp_content);
					});
					$("div[room='"+data.tag+"'] .user_list").append("</ul>");
				});
				
				$('#change_pseudo').click(function(){
					if($.trim($("#pseudo_input").val()) != "")
					{
						var pseudo = $.trim($("#pseudo_input").val());
						pseudo = pseudo.chunk(17);
						if(pseudo[1])
							pseudo = $.trim(pseudo[0])+"~";
						else
							pseudo = $.trim(pseudo[0]);
					
						socket.emit('nickname', (pseudo));
						$("#message_input").focus();
					}
					$("#pseudo_input").val('');
				});
				
				/* Style multi chatroom*/
				
				var active_rooms = new Array();
				active_rooms.push('general');
				var tab_number = 1;
				var tabTitle = $( "#join_chan" ),
				tabTemplate = "<li room='#{room}'><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close'>Fermer</span></li>";
				
				var tabs = $( "#chat_content" ).tabs({
					
					activate: function( event, ui ) {
						active_tab = $(ui.newPanel.selector).attr('room')
						$("li[room='"+active_tab+"']").addClass("ui-state-default")
					}
				});
				tabs.find( ".ui-tabs-nav" ).sortable({
					axis: "x",
					stop: function() {
						tabs.tabs( "refresh" );
					}
				});
				
				function addTab(source, chan_name) {
					if(source == "input")
						var label = $.trim(tabTitle.val()).toLowerCase();
					else
						var label = chan_name;
					var reg = new RegExp('/[^a-zA-Z0-9_]/g');
					if(!(reg.test(label)))
					{
						label = label.replace(/é|è|ê|ë/g, '').replace(/à|â/g, '').replace(/î|ï/g, '').replace(/ô|ö/g, '').replace(/û|ü|ù/g, '').replace(/ç/g, '').replace(/[^a-zA-Z0-9_' ]/g, '').replace(/'/g, '');
						label = label.replace(/ /g, '');
					}
					label = $.trim(label).toLowerCase();
					
					if($.inArray(label,active_rooms) == -1 && $.trim(label) != "")
					{
						active_rooms.push(label);
						var id = "tab_"+tab_number,
						li = $( tabTemplate.replace( /#\{href\}/g, "#" + id ).replace( /#\{label\}/g, label ).replace(/#\{room\}/g, label) ),
						tabContentHtml = '<div class="user_management"><h3>Utilisateurs connectés</h3><div class="user_list"></div></div><div class="container"></div>';
						socket.emit('join', label);
						tabs.find( ".ui-tabs-nav" ).append( li );
						tabs.append( "<div id='" + id + "' room='"+label+"'>" + tabContentHtml + "</div>" );
						tabs.tabs( "refresh" );
						$("#message_input").focus();
						var last_index = $('#chat_content > ul li').length;
						tabs.tabs({ active: last_index-1 });
						tab_number++;
					}
					tabTitle.val('');
				}
				
				$( "#chat_content span.ui-icon-close" ).live( "click", function() {
					var panelId = $( this ).closest( "li" ).remove().attr('room');
					Quit_Room(panelId, true);
				});
				
				function Quit_Room(panelId, send)
				{
					$("div[room='"+panelId+"']").remove();
					while (active_rooms.indexOf(panelId) !== -1) {
						active_rooms.splice(active_rooms.indexOf(panelId), 1);
					}
					
					if(send != false)
					{
						socket.emit('chanquit', panelId);
					}
					$( "#" + panelId ).remove();
					tabs.tabs( "refresh" );
				}
				
				$('#join_chan_button').click(function(){
					addTab("input", "");
				});
				
				function Check_Command(message)
				{
					var splited_message = message.split(" ");
					var temp_command = splited_message[0];
					var error = "<div class='chat_info'>Commande non valide. Tapez <b>/help</b> pour obtenir la liste des commandes disponibles</div>";
					
					switch (temp_command) {
						case "/help":
							if(splited_message.length == 1)
							{
								var content = "<div class='chat_info'>Liste des commandes : <br />";
								content += "/join room : rejoindre le salon<br />";
								content += "/quit : quiter le salon actif<br />";
								content += "/nick nickname : changer le pseduo";
								content += "</div>";
								return content;
							}
							else
								return error;
						break;
						case "/quit":
							if(splited_message.length == 1)
							{
								if(active_tab != "general")
								{
									$("li[room='"+active_tab+"']").remove();
									Quit_Room(active_tab, true);
									return false;
								}
								else
									return "<div class='chat_info'>Vous ne pouvez pas quitter le salon général</div>";
							}
							else
							{
								return error;
							}
						break;
						case "/join":
							if(splited_message.length == 2)
							{
								addTab("command", splited_message[1]);
								return false;
							}
							else
							{
								return error;
							}
						break;
						case "/nick":
							if($.trim(splited_message[1]) != "")
							{
								splited_message.splice(0, 1);
								var pseudo = $.trim(splited_message.join(" "));
								pseudo = pseudo.chunk(17);
								if(pseudo[1])
									pseudo = $.trim(pseudo[0])+"~";
								else
									pseudo = $.trim(pseudo[0]);
									
								socket.emit('nickname', (pseudo));
								$("#message_input").focus();
							}
							return false;
						break;
						default: 
							return "message";
						break;
					}

				}
				
				/* Controle utilisateur */
				var display_twittes = true;
				
				$('#disable_twitter').button({
					text: false,
					icons: {
						primary: "twitter-icon"
					}
				}).click(function( event ) {
					if(display_twittes)
					{
						$('.user_tweeter').addClass("hidden");
						display_twittes = false;
					}
					else
					{
						$('.user_tweeter').removeClass("hidden");
						display_twittes = true;
					}
				});
				$( "#user_controls" ).buttonset();
				
				socket.on('kick', function (data) {
					$("li[room='"+data+"']").remove();
					Quit_Room(data, false);
					socket.emit("kickend", data);
					var temp_index = $("div[room='"+active_tab+"']").attr('id');
					$('#'+temp_index+' .container').append("<div class='chat_info'>Vous avez été kické du channel "+data+" pour cause de flood</div>");
					$('#'+temp_index+' .container').scrollTop($('#'+temp_index+' .container').height());
				});
				
			});
			
        </script>
		
    </head>

    <body>
		<div id="ten_last">
			<h3>Dernières discussions</h3>
			<div id="ten_last_content"></div>
		</div>
        <div id="content">
			<div id="header">
				<h1>Chat'ouille <img src="img/logo-chatouille.png" alt="NodeJS Chat"></h1>
			</div>
			<div id="chat_area">
			
				<div id="tools_aera">
					<label for="pseudo_input">Pseudo :</label>
					<input type="text" id="pseudo_input" name="pseudo_input"/>
					<button id="change_pseudo" class="small_button">Ok</button>
					<label for="join_chan">Chatroom :</label>
					<input type="text" id="join_chan" name="join_chan"/><button class="small_button" id="join_chan_button">Rejoindre</button>
				</div>
				<div id="chat_content">
					<ul>
						<li room='general'><a href="#tab_0">General</a></li>
					</ul>
					<div id="tab_0" room='general'>
						<div class="user_management">
							<h3>Utilisateurs connectés</h3>
							<div class="user_list"></div>
						</div>
						<div class="container">
							<div class='chat_info'>Bievenue sur le Chat'ouille. Tapez <b>/help</b> pour obtenir la liste des commandes disponibles.</div>
						</div>
					</div>
				</div>
				<div id="user_message">
					<input type="text" id="message_input" name="message_input"/><button id="send_message" class="button">Envoyer</button>
					<div id="user_controls"><input type="checkbox" checked="checked" id="disable_twitter" /><label for="disable_twitter">Montre/Cacher le flux Twitter</label></div>
				</div>
			</div>
		</div>
    </body>
</html>
